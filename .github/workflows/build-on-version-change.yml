name: ğŸ§  Build on Plugin Version Change

on:
  push:
    branches:
      - main

permissions:
  contents: write

env:
  PLUGIN_SLUG: pd-shortcodes
  PLUGIN_MAIN_FILE: pd-shortcodes.php

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.diff.outputs.changed }}
      new_version: ${{ steps.extract.outputs.version }}
    steps:
      - name: ğŸ“¥ Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“Š Check for version change
        id: diff
        run: |
          if git rev-parse HEAD~1 >/dev/null 2>&1; then
            PREV_COMMIT=$(git rev-parse HEAD~1)
            if git diff $PREV_COMMIT HEAD -- $PLUGIN_MAIN_FILE | grep -q '^+.*Version:'; then
              CHANGED=1
            else
              CHANGED=0
            fi
          else
            echo "Only one commit â€“ assuming no version change."
            CHANGED=0
          fi
          echo "changed=$CHANGED" >> $GITHUB_OUTPUT

      - name: ğŸ· Extract version from plugin
        id: extract
        run: |
          VERSION=$(grep -oP 'Version:\s*\K[0-9.]+' $PLUGIN_MAIN_FILE)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

  build:
    needs: check-version
    if: needs.check-version.outputs.changed == '1'
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout repo
        uses: actions/checkout@v4

      - name: ğŸ§± Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.14.0
          cache: 'npm'

      - name: ğŸ˜ Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.2
          tools: composer

      - name: ğŸ“¦ Install dependencies (npm)
        run: |
          rm -rf node_modules package-lock.json
          npm install --legacy-peer-deps

      - name: ğŸ“œ Install PHP dependencies (composer)
        run: composer install --no-dev --optimize-autoloader

      - name: ğŸ›  Build plugin
        run: npm run build

      - name: ğŸ—œ Create ZIP
        run: |
          mkdir -p build
          zip -r build/${PLUGIN_SLUG}.zip . \
            -x "*.git*" "*.github*" "node_modules/*" "src/*" "tests/*" \
               "package-lock.json" "composer.json" "package.json" \
               "build/*"

      - name: ğŸš€ Release on GitHub
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.check-version.outputs.new_version }}
          name: v${{ needs.check-version.outputs.new_version }}
          files: build/${{ env.PLUGIN_SLUG }}.zip
